/**
 * ä¸»é¢˜æä¾›è€…ç»„ä»¶
 * 
 * è¿™ä¸ªç»„ä»¶è´Ÿè´£ï¼š
 * 1. ç›‘å¬ç”¨æˆ·è®¾ç½®ä¸­çš„ä¸»é¢˜é…ç½®
 * 2. ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼ˆå½“è®¾ç½®ä¸º'system'æ—¶ï¼‰
 * 3. åº”ç”¨CSSå˜é‡åˆ°DOM
 * 4. æä¾›ä¸»é¢˜ä¸Šä¸‹æ–‡ç»™å­ç»„ä»¶
 */

'use client';

import React, { createContext, useContext, useEffect, useState, useMemo } from 'react';
import { useUISettings } from '@/features/user/settings/data-access';
import {
    themes,
    generateCSSVariables,
    createCustomTheme,
    getColorPreset,
    type ThemeName,
    type ThemeConfig
} from '@/lib/theme/theme-config';

// ========== ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰ ==========
interface ThemeContextType {
    // å½“å‰åº”ç”¨çš„ä¸»é¢˜åç§°
    currentTheme: ThemeName;
    // å½“å‰ä¸»é¢˜é…ç½®å¯¹è±¡
    themeConfig: ThemeConfig;
    // ç”¨æˆ·è®¾ç½®çš„ä¸»é¢˜ï¼ˆå¯èƒ½æ˜¯'system'æˆ–'custom'ï¼‰
    userTheme: 'light' | 'dark' | 'system' | 'custom';
    // ç³»ç»Ÿæ£€æµ‹åˆ°çš„ä¸»é¢˜
    systemTheme: 'light' | 'dark';
    // ä¸»é¢˜åˆ‡æ¢å‡½æ•°
    setTheme: (theme: 'light' | 'dark' | 'system' | 'custom') => void;
    // æ˜¯å¦æ­£åœ¨åŠ è½½
    isLoading: boolean;
    // æ˜¯å¦æ˜¯è‡ªå®šä¹‰ä¸»é¢˜æ¨¡å¼
    isCustomTheme: boolean;
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

// ========== ä¸»é¢˜æä¾›è€…ç»„ä»¶ ==========
interface ThemeProviderProps {
    children: React.ReactNode;
    defaultTheme?: 'light' | 'dark' | 'system' | 'custom';
}

export function ThemeProvider({ children }: ThemeProviderProps) {
    // ä»è®¾ç½®ä¸­è·å–ç”¨æˆ·ä¸»é¢˜åå¥½
    const { settings, updateSettings } = useUISettings();

    // ç³»ç»Ÿä¸»é¢˜æ£€æµ‹
    const [systemTheme, setSystemTheme] = useState<'light' | 'dark'>('light');
    const [isLoading, setIsLoading] = useState(true);
    const [isMounted, setIsMounted] = useState(false);

    // è®¡ç®—å½“å‰åº”è¯¥åº”ç”¨çš„ä¸»é¢˜å’Œé…ç½®
    const currentTheme: ThemeName = (() => {
        if (settings.theme === 'system') return systemTheme;
        if (settings.theme === 'custom') {
            // è‡ªå®šä¹‰ä¸»é¢˜åŸºäºç”¨æˆ·é€‰æ‹©çš„æ·±æµ…æ¨¡å¼
            return settings.customTheme?.isDarkMode ? 'dark' : 'light';
        }
        return settings.theme;
    })();

    // è·å–ä¸»é¢˜é…ç½® - ä½¿ç”¨useMemoæ¥ç¨³å®šå¼•ç”¨
    const themeConfig: ThemeConfig = useMemo(() => {
        if (settings.theme === 'custom' && settings.customTheme) {
            const preset = getColorPreset(settings.customTheme.colorPresetName);
            if (preset) {
                // ç¡®ä¿è‡ªå®šä¹‰é¢œè‰²ç±»å‹æ­£ç¡®
                const customColors = settings.customTheme.customColors;
                const validCustomColors: Partial<ThemeConfig['colors']> | undefined = customColors ? {
                    background: customColors.background ? {
                        primary: customColors.background.primary || '',
                        secondary: customColors.background.secondary || '',
                        tertiary: customColors.background.tertiary || '',
                        inverse: customColors.background.inverse || ''
                    } : undefined,
                    foreground: customColors.foreground ? {
                        primary: customColors.foreground.primary || '',
                        secondary: customColors.foreground.secondary || '',
                        tertiary: customColors.foreground.tertiary || '',
                        inverse: customColors.foreground.inverse || ''
                    } : undefined,
                    border: customColors.border ? {
                        primary: customColors.border.primary || '',
                        secondary: customColors.border.secondary || '',
                        focus: customColors.border.focus || ''
                    } : undefined,
                    accent: customColors.accent,
                    muted: customColors.muted,
                    destructive: customColors.destructive,
                    success: customColors.success,
                    warning: customColors.warning,
                    error: customColors.error,
                    info: customColors.info
                } : undefined;

                return createCustomTheme(
                    preset,
                    settings.customTheme.isDarkMode,
                    validCustomColors
                );
            }
        }
        return themes[currentTheme];
    }, [settings.theme, settings.customTheme, currentTheme]);

    const isCustomTheme = settings.theme === 'custom';

    // ========== å®¢æˆ·ç«¯æŒ‚è½½æ£€æµ‹ ==========
    useEffect(() => {
        setIsMounted(true);
    }, []);

    // ========== ç³»ç»Ÿä¸»é¢˜æ£€æµ‹ ==========
    useEffect(() => {
        if (!isMounted) return;

        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

        // åˆå§‹æ£€æµ‹
        setSystemTheme(mediaQuery.matches ? 'dark' : 'light');
        setIsLoading(false);

        // ç›‘å¬å˜åŒ–
        const handleChange = (e: MediaQueryListEvent) => {
            setSystemTheme(e.matches ? 'dark' : 'light');
        };

        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
    }, [isMounted]);

    // ========== CSSå˜é‡åº”ç”¨ ==========
    useEffect(() => {
        // è°ƒè¯•æ—¥å¿— - æŸ¥çœ‹çŠ¶æ€
        if (process.env.NODE_ENV === 'development') {
            console.log('ğŸ” ThemeProvider çŠ¶æ€æ£€æŸ¥:', {
                isLoading,
                currentTheme,
                userTheme: settings.theme,
                systemTheme,
                isMounted
            });
        }

        if (isLoading || !isMounted) {
            console.log('â³ è·³è¿‡CSSå˜é‡åº”ç”¨:', {
                isLoading,
                isMounted
            });
            return;
        }

        if (!themeConfig) {
            console.log('â³ ä¸»é¢˜é…ç½®æœªæ‰¾åˆ°:', { currentTheme, settingsTheme: settings.theme });
            return;
        }

        const variables = generateCSSVariables(themeConfig);
        const root = document.documentElement;

        // åº”ç”¨CSSå˜é‡ï¼ˆè‡ªå®šä¹‰ä¸»é¢˜å’Œæ ‡å‡†ä¸»é¢˜éƒ½éœ€è¦ï¼‰
        Object.entries(variables).forEach(([property, value]) => {
            root.style.setProperty(property, value);
        });

        // è®¾ç½®data-themeå±æ€§ï¼Œä¾›CSSé€‰æ‹©å™¨ä½¿ç”¨
        const themeAttr = isCustomTheme ? 'custom' : currentTheme;
        root.setAttribute('data-theme', themeAttr);

        // è®¾ç½®classï¼Œå…¼å®¹Tailwindçš„dark:å‰ç¼€
        if (currentTheme === 'dark') {
            root.classList.add('dark');
            root.classList.remove('light');
        } else {
            root.classList.add('light');
            root.classList.remove('dark');
        }

        // ä¸ºè‡ªå®šä¹‰ä¸»é¢˜æ·»åŠ é¢å¤–çš„class
        if (isCustomTheme) {
            root.classList.add('theme-custom');
        } else {
            root.classList.remove('theme-custom');
        }

        // è°ƒè¯•æ—¥å¿—
        if (process.env.NODE_ENV === 'development') {
            console.log('ğŸ¨ ä¸»é¢˜å·²åº”ç”¨:', {
                userTheme: settings.theme,
                systemTheme,
                currentTheme,
                isCustomTheme,
                customTheme: settings.customTheme,
                variablesCount: Object.keys(variables).length,
                sampleVariables: {
                    '--primary': variables['--primary'],
                    '--destructive': variables['--destructive'],
                    '--color-accent': variables['--color-accent']
                }
            });
        }
    }, [themeConfig, currentTheme, systemTheme, isLoading, isMounted, settings.theme, settings.customTheme, isCustomTheme]);

    // ========== ä¸»é¢˜åˆ‡æ¢å‡½æ•° ==========
    const setTheme = (theme: 'light' | 'dark' | 'system' | 'custom') => {
        updateSettings({ theme });
    };

    // ========== ä¸Šä¸‹æ–‡å€¼ ==========
    const contextValue: ThemeContextType = {
        currentTheme,
        themeConfig: themeConfig,
        userTheme: settings.theme,
        systemTheme,
        setTheme,
        isLoading,
        isCustomTheme
    };

    // åŠ è½½çŠ¶æ€
    if (isLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-white">
                <div className="animate-pulse">
                    <div className="w-8 h-8 bg-blue-600 rounded-full"></div>
                </div>
            </div>
        );
    }

    return (
        <ThemeContext.Provider value={contextValue}>
            {children}
        </ThemeContext.Provider>
    );
}

// ========== ä¸»é¢˜Hook ==========
export function useTheme() {
    const context = useContext(ThemeContext);

    if (context === undefined) {
        throw new Error('useTheme must be used within a ThemeProvider');
    }

    return context;
}

// ========== ä¸»é¢˜å·¥å…·å‡½æ•° ==========

/**
 * è·å–CSSå˜é‡å€¼
 */
export function getCSSVariable(name: string): string {
    if (typeof window === 'undefined') return '';
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

/**
 * è®¾ç½®CSSå˜é‡å€¼
 */
export function setCSSVariable(name: string, value: string): void {
    if (typeof window === 'undefined') return;
    document.documentElement.style.setProperty(name, value);
}

/**
 * ä¸»é¢˜é¢œè‰²è·å–å™¨
 */
export function useThemeColors() {
    const { themeConfig } = useTheme();

    return {
        // èƒŒæ™¯è‰²
        background: {
            primary: getCSSVariable('--color-background-primary'),
            secondary: getCSSVariable('--color-background-secondary'),
            tertiary: getCSSVariable('--color-background-tertiary'),
        },
        // å‰æ™¯è‰²
        foreground: {
            primary: getCSSVariable('--color-foreground-primary'),
            secondary: getCSSVariable('--color-foreground-secondary'),
            tertiary: getCSSVariable('--color-foreground-tertiary'),
        },
        // åŠŸèƒ½è‰²
        accent: getCSSVariable('--color-accent'),
        success: getCSSVariable('--color-success'),
        warning: getCSSVariable('--color-warning'),
        error: getCSSVariable('--color-error'),
        info: getCSSVariable('--color-info'),
        // å®Œæ•´é…ç½®
        config: themeConfig.colors
    };
}

/**
 * å“åº”å¼ä¸»é¢˜æ£€æµ‹
 */
export function useSystemTheme() {
    const [systemTheme, setSystemTheme] = useState<'light' | 'dark'>('light');

    useEffect(() => {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

        setSystemTheme(mediaQuery.matches ? 'dark' : 'light');

        const handleChange = (e: MediaQueryListEvent) => {
            setSystemTheme(e.matches ? 'dark' : 'light');
        };

        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
    }, []);

    return systemTheme;
}

export default ThemeProvider;
