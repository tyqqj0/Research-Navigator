# 文献上下文快速添加覆盖层

## 概述

- 目的：为每个文献列表引入上下文化的"添加文献"入口，同时保持跨页面快速添加工作流的一致性。
- 核心理念：每个文献列表渲染自己的突出添加按钮，打开一个专注的覆盖层，包含标识符解析、发现搜索和集合路由逻辑。
- 预期结果：从DOI/arXiv/论文ID更快速地录入，为模糊输入提供引导式自然语言发现，并最小化对非文献页面的干扰。

## 问题陈述

- 现有发现页面提供搜索+添加流程，但位于专用路由；列表内的操作者必须导航离开才能录入项目。
- 当前的`LiteratureEntryPoint`涵盖了后端功能，但缺乏可在列表出现位置（图书馆根目录、集合视图、会话面板等）重用的有主见的UI。
- 我们需要一个统一的用户体验，既尊重列表上下文（全局vs特定集合），又不会向无关路由注入全局chrome。

## 范围

- 包含范围：可重用覆盖层组件、每个列表的触发按钮、标识符解析逻辑、候选项展示和添加到集合的行为。
- 排除范围：后端服务更改（重用现有的`literatureDomainServices` + `webDiscovery`）、超出当前API表面的高级批量导入、与笔记/数据集模块的深度集成。

## 用户故事

- 作为浏览整个图书馆的研究者，我可以点击列表标题内清晰可见的"添加"按钮，粘贴DOI/URL/论文哈希，并将结果放入选择的集合或保持未分类状态。
- 作为查看特定集合或会话绑定列表的研究者，同样的按钮将新文献直接添加到该上下文中，无需冗余的选择步骤。
- 作为只有自然语言想法的用户（"图变换器 2024"），我可以从覆盖层搜索，检查排名候选项，并有选择地添加一个或多个项目。

## 用户体验与交互设计

### 触发器位置

- 为每个文献列表组件（图书馆概览、集合详情、会话信息面板、紧凑抽屉）添加专用的快速添加按钮。
- 位置：默认为列表标题/右对齐；保持响应式布局（小视口时堆叠或仅图标）。
- 视觉样式：强调色按钮带图标（例如，加号+文档）以区别于过滤器/排序控件。

### 覆盖层组成

- 使用`Dialog`原语和自定义覆盖层样式（模糊背景、居中面板、保留挂载以用于动画）。
- 面板部分：
  - **标识符输入**：大输入框，占位符`输入 DOI / arXiv / PaperID 或关键词…`，主要CTA`解析`
  - **状态横幅**：内联反馈（解析成功、等待搜索、错误、重复）
  - **候选列表**：
    - 对于直接标识符：渲染显示元数据的单个候选卡片；CTA`添加到{目标}`
    - 对于自然语言搜索：列出最多N个候选项（默认8个），带元数据片段、`+ 入库`按钮、可选的"添加全部"次要CTA
  - **集合路由**：上下文摘要（"将添加到：集合 · X"或"请选择集合"），必要时带下拉/选择器。
- 持久页脚带`完成`（关闭）和键盘提示（Enter提交，Esc关闭）。

### 状态与反馈

- 解析或添加时CTA按钮上的加载旋转器。
- 通过`sonner`发送成功提示（`已添加到文库`，可选显示paperId）和失败提示（来自API的错误消息）。
- 搜索失败时的空结果消息，带重试建议。

## 标识符决策树

```
输入（已修剪）
├─ 匹配前缀DOI/arXiv/等 → 通过`LiteratureEntryPoint.normalizeIdentifier`标准化
│   └─ 作为来自后端元数据的单个候选项展示
├─ 40字符十六进制字符串（不区分大小写） → 视为paperId（S2哈希）
│   └─ 通过`services.backend.getPaper`查询后端 → 候选视图
├─ 其他前缀模式（例如，CorpusId:123） → 同第一分支
└─ 默认 → 视为自然语言查询 → `webDiscovery.searchWeb`
    └─ 渲染候选列表供手动选择
```

- DOI和arXiv检测依赖于前缀（不区分大小写）和`LiteratureEntryPoint`中的现有标准化。
- 论文哈希检测：正则表达式`[0-9a-f]{40}`（允许大写）确保裸S2 ID映射到直接查找。
- 回退搜索利用来自`useSettingsStore`的域过滤器，就像发现页面一样。

## 集合处理规则

- 快速添加按钮接收可选的`contextCollectionId`。
- 如果提供，所有添加操作默认到该集合（包括"添加全部"）。
- 如果没有（全局图书馆），覆盖层显示集合选择器，选项为：
  - `添加到集合…`（内联打开`CollectionSelectDialog`）
  - `仅添加到文库`（无集合关联）
- 选择在覆盖层保持打开时持续；关闭时重置以防止上下文间泄漏。

## 数据流与模块

1. **触发器**（`LiteratureListHeader`）在覆盖层组件上设置`open=true`，传递`contextCollectionId`。
2. **标识符提交**调用新hook`useLiteratureQuickAdd`：
   - 根据决策树解析。
   - 对直接标识符使用`literatureEntry.addByIdentifier`（包装以在最终确认前显示候选项）。
   - 对自然语言路径使用`webDiscovery.searchWeb`。
3. **候选选择**：
   - 调用`webDiscovery.addIdentifierToLibrary(identifier, { addToCollection(s) })`
   - 通过同步存储（`useLiteratureStore`、`useCollectionStore`）处理重复响应。
4. **覆盖层**监控存储更新以反映新添加的项目（可选择在列表中立即高亮）。

## 实施计划

1. **基础设施**
   - 创建`useLiteratureQuickAdd` hook，封装解析、状态和API交互。
   - 扩展`CollectionSelectDialog`以支持内联渲染（或为全局上下文构建精简选择器组件）。
2. **UI组件**
   - 使用`Dialog`构建`LiteratureQuickAddOverlay`组件。
   - 构建与发现页面共享的`CandidateList`和`CandidateCard`子组件。
3. **触发器集成**
   - 将按钮注入`LiteratureLibraryView`、`CollectionDetailView`、`SessionLiteraturePanel`和任何其他文献列表容器。
   - 确保每个都提供`contextCollectionId`（或`undefined`）。
4. **存储同步**
   - 成功添加后，刷新相关列表查询或推送到本地存储。
   - 尊重现有的`composition.createComposedLiterature`流程以维护增强管道。
5. **样式与可访问性**
   - 对齐覆盖层宽度约640px，向下响应到移动端（全屏表单模式）。
   - 支持键盘快捷键（Enter、Esc、通过漫游tabindex进行列表箭头导航）。

## 错误处理与边缘情况

- 直接标识符返回但添加失败（重复、权限） → 显示提示，保持候选列表可见以便重试。
- 后端对直接查找返回无论文 → 回退消息建议搜索路径。
- 批量"添加全部"应按顺序处理以显示部分失败（收集成功/失败数组以用于摘要提示）。
- 网络错误 → 显示内联错误状态和重试按钮。

## 测试策略

- 单元测试：标识符决策树、hook状态转换、集合路由逻辑。
- 集成测试（Playwright/Cypress）：
  - 在集合视图中通过DOI添加 → 新项目出现在列表中。
  - 在图书馆视图中通过裸哈希添加 → 提示选择集合或全局；选择工作正常。
  - 自然语言搜索+多选添加路径。
  - 重复标识符优雅地报告已存在并同步存储。

## 开放问题

- 我们是否在全局上下文中显示最近使用的集合以便更快选择？
- 覆盖层是否应该记住每个列表会话的最后查询或每次打开都重置？
- 是否有速率限制需要防抖或对重复API命中发出警告？
- 移动布局：偏好底部表单vs居中模态？


