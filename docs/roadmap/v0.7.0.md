## Research Navigator v0.7.0 Roadmap

目标：统一交互与视觉、简化流程、明确模型分工、提升报告与关系图生成质量。

### 1) UI/UX 改造

- 文献详情 Overlay（右侧上层覆盖）
  - 行为：点击文献（文库/图谱/会话）在右侧以 Overlay Drawer 打开，背景 `backdrop-blur`，**不挤压主布局**。
  - 交互：Esc/点击蒙层关闭；支持路由/状态直链（可分享/返回）。
  - 动效：进入/退出过渡（250–300ms），滚动独立。
  - 适配：统一一个 `OverlayPanel` 组件，被文库与图谱共用，减少双处适配。
  - 验收：不同入口点击同一文献打开同一详情视图；主界面布局不变化；移动端占满屏。

- 研究会话卡片统一
  - 统一使用 UI 库的卡片容器（Header/Body/Footer），支持流式填充与 Skeleton。
  - 卡片类型：研究方向、搜索/扩展进度、确认（需最小化显示）、报告、提示/操作等。
  - Markdown 支持：报告卡片使用 `react-markdown`（或现有 MD 渲染器），代码块、表格、列表、内联公式。
  - 颜色：研究方向卡片保留主题色；其余遵循语义色（info/success/warn）。
  - 验收：所有卡片风格一致、支持流式更新、报告正文正确渲染 Markdown。

- 图谱窗格可收放
  - 行为：在会话页面提供“图谱”侧窗 Toggle；任一阶段均可展开/收起。
  - 状态：每会话独立持久化 `graphPanelOpen`；阶段切换仅改变默认展开状态，不强制隐藏。
  - 验收：用户手动开关与阶段默认值不冲突；刷新后恢复最近一次选择。

- 会话列表改造
  - 新建会话按钮：移入列表第一个条目，保持显著 CTA。
  - 列表项：显示标题、最近时间、当前选中高亮、右侧叉号快删（×）。
  - 排序：支持拖拽排序（dnd-kit），顺序持久化。
  - 验收：拖拽排序生效；删除有确认；当前项有清晰高亮；新建在顶部。
  - 顶部栏右上角的新建会话去掉

- 图谱中心吸引
  - 图谱中间靠右一点加上吸引力，确保页面大小切换时节点能保留在合适位置
  - 加一个设置项，可以动态开启关闭节点与节点，节点与边之间的纵向力
  - 借助纵向力设置项，实现拖动时其他节点会上下避让拖动节点，松手时所有节点应该停留在精准的时间线上的效果

### 2) 运行流程自动化

- 阶段串联（默认自动，无需按钮）
  1. 方向确认 → 自动开始集合扩展（StartExpansion）
  2. 扩展停止条件：
     - `EXPANSION_MAX_ROUNDS` 达到；或
     - 最近一轮新增为 0；或
     - 集合总量超过 `COLLECTION_UPPER_BOUND`
  3. 超上限自动裁剪：`PruneCollection(targetMax=PRUNE_TARGET_MAX, rule=citation_low_first)`
  4. 扩展/裁剪完成 → 自动构建关系图（BuildGraph(window=GRAPH_WINDOW_SIZE)）
  - 验收：确认方向后无需手动点击，流程能自动走完；各阈值可由 `runtimeConfig` 调整。

- 噪声信息抑制
  - 系统事件如“已确认方向”“开始扩展”“扩展已停止”不在聊天区展示，改入状态提示或小型 Badge。
  - 保留必要的人类可读进度，隐藏冗余重复段落。
  - 验收：对话区不再出现系统冗余段落；进度通过轻量 UI 呈现。

- DeepResearch 单一主流程
  - 当前如果开启 Deep Research 会同时触发普通对话和研究方向提案生成。
  - 若开启 deepresearch：仅启动“研究主流程”，不再并发常规对话生成研究方向。
  - 验收：同一 Query 不会触发两套并行流程。

- 当前若搜索到的论文已在文库，会意外触发扩展已停止（原因：max_rounds）

- 加一个功能，删除会话的时候提示，是否需要连带删除关联的集合和图谱，可以选删会话，删会话和集合，和全部删除，然后弹出来的窗口改成现在ui组件库里面的确认弹窗

### 3) 模型分工策略（Thinking vs Task）

- Thinking Model（推理/生成型，温度中等，长上下文）
  - 研究方向提案与确认
  - 关系图“关系提案”文本（先思考后结构化）（后续改）
  - 报告多阶段：大纲→分节扩写→摘要重写 （后续改）

- Task Model（工具/检索/解析，确定性更高）
  - 查询生成与搜索、元数据读取、集合裁剪、关系文本到边结构解析（部分暂未实现，仅考虑以实现的功能）

- 配置
  - 在全局设置里面读取两种模型的配置，注入ai生成底层，ai生成模块向上暴露设置用哪个模型跑的参数接口（考虑未来可扩展性）

### 4) 提示词与生成链路

- 关系图生成（替换启发式占位）
  - 输入：当前图窗口内节点 `{id, title, firstAuthor, year, abstract}`。
  - 步骤：
    1) Thinking：对节点语义分群并确定主线脉络（不输出边，时间从旧到新）。
    2) Thinking：产出候选关系说明（JSONL，含 rationale 与 evidence 字段，tags 支持 主线|支线|重要|弱证据）。
    3) Task：将文本转为结构化边数组：`{sourceId, targetId, relation, tags, rationale, evidence, confidence}`。
    4) 规则验证：当 relation=引用|改进|继承 时，要求 `year(source) <= year(target)`。
    5) 仅保留端点均在图中的边（Repository 层已基于 from/to/relation 去重）。
  - 输出：批量写入图，保留 `tags` 与 `meta.rationale/evidence`。
  - 验收：能生成非空边；重复生成幂等；在窗口大小内复杂度可控。

- 报告生成多阶段
  - 1) 大纲：基于图谱结构与方向，生成章节树与每节要点（Thinking）。
  - 2) 分节扩写：按大纲逐节生成，带 cite 键位（Thinking）。
  - 3) 摘要：回看全文后重写摘要（Thinking）。
  - 渲染：拼接时保持章节顺序；References 仍由系统渲染，正文只用 `[@key]`。
  - 验收：报告质量较现有直出明显提升（结构更清晰、引用更稳定）。

### 5) 体验细节

- 会话标题自动生成
  - 在接收用户 Query 后，用 Task 模型生成 6–10 字简短标题，写入会话（可手改）。
  - 验收：标题生成稳定、无敏感词；多语言输入时能产出中文题名（可配置）。

- 卡片流式与状态
  - 统一 `StreamCard`：`idle | streaming | done | error`，均支持 Skeleton 与进度条。
  - 验收：长任务期间，用户可以实时看到内容逐步填充。

### 6) 配置与开关

在 `runtime-config.ts` 补充：

```ts
export const runtimeConfig = {
  EXPANSION_MAX_ROUNDS: 4,
  EXPANSION_ROUND_SIZE: 8,
  COLLECTION_UPPER_BOUND: 50,
  PRUNE_TARGET_MAX: 50,
  GRAPH_WINDOW_SIZE: 50,
  MODELS: { thinking: 'gpt-4.1', task: 'gpt-4o-mini' },
  TITLE_GEN_LOCALE: 'zh-CN',
  UI: { defaultGraphOpen: true }
} as const;
```

### 7) 里程碑

1. 文献详情 Overlay 与会话列表改造（UI 统一基础设施）
2. 会话页卡片统一与图谱窗格收放
3. 自动化流程打通（方向→扩展→裁剪→建图）与噪声抑制
4. 关系图提示词与结构化生成落地
5. 报告多阶段生成链路
6. 调参与打磨，完善验收与回归用例

—— 本文档随实现同步更新具体接口与组件命名。


###  8)补充
1. zotero: 与旧版模式相似，可以填充zotero的key，然后导入zotero的文献库内容，和笔记（可以先做一个简单的数据结构，关联笔记和文献的paperid or usermeta）
2. 方案报告的自动决策：优化一下第一部分的第一个方案，检测到<direction>标记再生成方案确认卡片（相当于默认信息足够生成方案），不然就是等待用户输入回答（相当于默认信息不够，进入一个自环流程），并且重新进入第一个方案生成的节点并再次判断。
3. 图谱滚动防抖，按住ctrl时禁用鼠标的上下滚动：现在文献图谱在缩放的时候会滚动一下再吸回去，显得很抖。
4. [@AnonUnderstanding2025; @AnonExploring2025_b]这种连续引用无法引用
5. 图谱在对话生成时的抖动：图谱在对话生成的时候会持续刷新
6. 主页面即对话：现在的主页面是仪表盘，但是想了想，还是一个对话页面的使用成本最小，最直观，顺便，这里在想，左侧的导航边栏里面，改一下顺序，第一个是研究，第二个是文库，第三个是图谱，第四个是仪表盘，第五个是文献发现，然后是其他，里面有笔记（暂时就这一个）。最好路由也改一下
7. 会话顶部名称改成会话名称（已做）
8. 大数据量图谱优化：现在文库的引用关系图谱，现在的有一百多个节点就很卡，看看为什么
9. 优化添加文献的ui：现在是一个小输入窗口，而且智能输入doi,url,s2id等，现在想能不能做成一个全局的组件，就是一个小按钮，点击之后中间蹦出来一个类似于搜索页面现在的样子的搜索页面（不过是浮空的，背景虚化，这里最好还考虑一下，可以传入当前集合的参数，可能添加逻辑和搜索页面稍微有点区别（搜索页面是先添加按钮，然后选集合，而在文库页面，或者图谱或者研究页面里面，是可能有当前的关联集合的，直接添加即可））
10. 跳转文献阅读页面，文献详情页面，支持跳转S2 or PDF(通过后端pdf中字段获取)
11. step标记去重（现在会显示step2,step2.1,step2,step2.1...，去重？）
12. 模型配置列表：做一个模型配置文件，不准许自定义模型，后续这个模型配置都从后端去传

## Research Navigator v0.7.1 Roadmap

目标：快速打磨体验、修复抖动、完善导入与引用、统一入口。

### 1) 导航与首页

- 主页面即对话
  - 行为：将 `/` 指向对话页；保留原仪表盘入口。
  - 侧边栏顺序：研究 → 文库 → 图谱 → 仪表盘 → 文献发现 → 其他（笔记）。
  - 验收：直接进入对话；侧边栏顺序正确；深链与历史路由可用。

### 2) 图谱体验与性能

- 滚动防抖与 Ctrl 缩放防冒泡
  - 行为：Ctrl+滚动缩放时阻止页面滚动；图谱容器设置 `overscroll-behavior: contain`；缩放事件防抖。
  - 验收：缩放不再造成页面“吸回”；缩放平滑，父级不跟随滚动。

- 生成时抖动修复（对话生成期间）
  - 策略：稳定组件 props；对状态更新做 `requestAnimationFrame` 节流；快速变更期间暂时降低/关闭物理引擎；节点/边按差量更新。
  - 验收：对话流式输出时图谱不抖动；既有节点位置稳定，交互不中断。

- 大图优化（>100 节点）
  - 策略：按规模自适应下调迭代/斥力；布局稳定后冻结；惰性渲染/抽帘边；必要时将布局迁入 Web Worker；限制 tick 频率。
  - 验收：200–300 节点仍可流畅交互；CPU 占用稳定；无明显卡顿。

### 3) 文献与引用

- Zotero 导入（文库 + 笔记）
  - 配置：新增 Zotero API Key / Library / User 设置项。
  - 数据：通过 Web API 拉取条目与笔记；映射为 `library-item` 与 `composition`；笔记按 `paperId` 或 userMeta 关联。
  - 验收：可导入条目与对应笔记；来源标记为 `zotero`；重复导入幂等合并。

- 连续引用解析 `[@AnonUnderstanding2025; @AnonExploring2025_b]`
  - 能力：支持 `;` 分割多引用；支持 `_a/_b` 后缀；渲染多个链接与悬浮/跳转。
  - 验收：多引用正确生成链接；单引用不回归；Markdown 其他特性不受影响。

- 全局“添加文献”浮层
  - 入口：全局通用按钮组件；从任意页面接入，替换原本文献列表里面的添加框。
  - 能力：智能解析 DOI / URL / S2；输入自然语言来搜索，类似与文献发现页面,弹出一个正中间的悬浮页面，有一个搜索框，提示可以输入id或这搜索query输入id出一个列表选项，输入query出现好几个文献的列表。可接受 `currentCollectionId` 以直接添加（有全部添加按钮）；否则弹出集合选择。
  - 验收：任一页面可一键添加；在集合上下文中免二次选择；失败有错误提示。

- 一键跳转阅读（S2 / PDF / URL）
  - 规则：优先打开 PDF（`pdfPath`）→ S2 页面 → 原始 URL；无可用目标时禁用按钮。
  - 验收：点击即打开最合适目标；无可用目标时禁用且有提示。

### 4) 会话流程

- `<direction>` 自动决策
  - 行为：在模型输出检测到 `<direction>` 时直接生成确认卡并进入主流程；否则请求用户补充后回到首节点再次判断。
  - 验收：信息充分时无需额外交互即可进入流程；信息不足时进入自环补全。

- step 标记去重
  - 行为：在 projector 层去重；每会话维护已发出 step 的集合；保持原顺序与阶段边界。
  - 验收：`step2/step2.1` 等不再重复出现；历史回放一致。

### 5) 模型配置

- 受控模型列表
  - 行为：将模型选择改为白名单下拉；移除自由输入；预留后端下发能力。
  - 验收：仅可选择受支持模型；设置持久化；相关 UI 同步更新。

### 6) 实施顺序

1. 快速体验：导航与首页、滚动防抖、连续引用、step 去重、阅读跳转
2. 稳定与性能：生成时抖动修复、大图优化、全局添加浮层
3. 集成与管控：Zotero 导入、模型配置白名单化

### 7) 风险与注意事项

- 图谱性能：优先通过参数与节流优化；必要时再 worker 化（需结构化传输数据）。
- Zotero 限流：分批抓取与指数退避；MVP 先支持单库，逐步扩展。
- Markdown 解析：确保与现有渲染特性共存；为解析器补最小单元测试。
- 路由调整：校验 `src/app/research/[sessionId]/page.tsx` 等深链与分享链接。

- 覆盖 0.7.0 补充项：1、2、3、4、5、6、8、9、10、11、12。

